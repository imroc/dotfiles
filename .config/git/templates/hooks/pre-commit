#!/bin/bash
# Git pre-commit hook: è‡ªåŠ¨æ£€æŸ¥å¹¶ä¿®æ­£è…¾è®¯å†…éƒ¨ä»“åº“çš„ç”¨æˆ·é…ç½®
#
# åŒ¹é…åŸŸå: git.woa.com, git.code.oa.com
# å…¬å¸è´¦æˆ·: rockerchen <rockerchen@tencent.com>

COMPANY_NAME="rockerchen"
COMPANY_EMAIL="rockerchen@tencent.com"
INTERNAL_DOMAINS="git.woa.com|git.code.oa.com"

# è·å–æ‰€æœ‰ remote URL
remote_urls=$(git remote -v 2>/dev/null | awk '{print $2}' | sort -u)

if [ -z "$remote_urls" ]; then
    exit 0
fi

# æ£€æŸ¥æ˜¯å¦ä¸ºè…¾è®¯å†…éƒ¨ä»“åº“
is_internal=false
for url in $remote_urls; do
    if echo "$url" | grep -qE "$INTERNAL_DOMAINS"; then
        is_internal=true
        break
    fi
done

if [ "$is_internal" = false ]; then
    exit 0
fi

# æ£€æŸ¥å½“å‰ä»“åº“çš„ user é…ç½®
current_email=$(git config user.email)

if [ "$current_email" != "$COMPANY_EMAIL" ]; then
    echo "ğŸ”§ æ£€æµ‹åˆ°è…¾è®¯å†…éƒ¨ä»“åº“ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸ºå…¬å¸è´¦æˆ·..."
    git config user.name "$COMPANY_NAME"
    git config user.email "$COMPANY_EMAIL"
    echo "âœ… å·²è®¾ç½®: $COMPANY_NAME <$COMPANY_EMAIL>"
fi

exit 0
